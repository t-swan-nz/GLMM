Loading packages
```{r}
library(qtl)
library(ggplot2)
library(pscl)
library(boot)
library(psych) 
library(stats) 
library(MASS)
library(car)
library(lmtest)
library(lme4)
library(tidyverse)
library(tibble)
library(aods3)
library(emmeans)
library(dplyr)
library(MuMIn)
library(DHARMa)
library(blmeco)
library(cowplot)
```

Importing the data
```{r}
TSI_data <- read.csv(file = "TSI_data.csv")
```

Summary statistics
```{r}

total_sugar <- sum(TSI_data$sugar)

TSI_data %>% 
  ggplot() +
  geom_violin(aes(x=time, fill = sex, y=sugar))

#count of sugar by sex

ggplot(TSI_data, aes(x=sex, y=sugar_sum)) + geom_point()

sugar_sum <- sum(TSI_data$sugar)

TSI_data_plots <- TSI_data %>% mutate(sugar= as.factor(sugar)) %>% 
  dplyr::group_by(sex,time,habitat) %>% dplyr::summarise(count(sugar))

#rename "x" to "sugar" 

TSI_data_plots %>% ggplot() + geom_bar(aes(x =TSI_data_plots$time, y =TSI_data_plots$freq))

TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =, y = stat(prop), group=1))

#count of sugar fed by time of day
TSI_data %>% ggplot() + geom_bar(mapping = aes(x =sex, y = stat(count), group=1))

#proportion of sugar fed by time of day
TSI_data %>% ggplot() + geom_bar(mapping = aes(x =sex, y = stat(prop), group=1))

#count of sugar fed by time of day, fill = sugar
TSI_data %>% ggplot() + geom_bar(mapping = aes(x =sex, y = stat(count), group=1))

TSI_data_plots <- TSI_data %>% mutate(sugar= as.factor(sugar)) 

str(TSI_data_plots)

#convert integer to factor

as.factor(TSI_data_plots$sugar)

str(TSI_data_plots)

#proportion
TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =sex, fill=habitat))

#more male albopictus captured in the bush than in the urban habitat.

#time of day - more female captured in the afternoon 
TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =sex, fill=time, stat(count)))

#time of day - try position 'dodge'
TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =sex, fill=sugar))

#Quite interesting. Our physiological examination was able to detect the presence of sugar. #rename this to negative or positive. 
TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =contents, fill=sugar))+ labs(x= "visual examination", y = "count", fill= "Status") + theme_cowplot() + theme_minimal_grid(12)

#time
TSI_data_plots %>% ggplot() + geom_bar(mapping = aes(x =time, size = sex,fill=sugar)) + labs(x= "Visual examination", y = "Count", fill= "Status") + theme_cowplot()

#maybe look at fructose concentration by sex
TSI_data_plots %>% ggplot() + geom_point(aes(y= fructose_concentration, x=habitat, color = sex))

TSI_data_plots %>% ggplot() + geom_point(aes(y= sweeptime, x=habitat, color = time))



#this one shows that more females than males were captured in both the morning and afternoon.
TSI_data_plots %>% ggplot(mapping = aes(x =time, fill=sex)) + geom_bar(position="dodge")



TSI_data_plots %>% ggplot(mapping = aes(x=time, fill=sugar)) + geom_bar(position="dodge")
#maybe split this by sex? and the facet it?

#think about a facet_grid for comparing count with sex, facetted by time of day. 
TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="dodge") + facet_grid(cols = vars(time))  + labs(x= "Sex", y = "Count", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#look at differences between time of day, sugar positive and sex - this one relates to the GLMM.#significant difference between sugar positive for (i) afternoon female - afternoon male (ii) morning female - afternoon male (iii) afternoon male - morning male. 

#there was more sugar feeding in the afternoon than the morning. 

#final figures examples

```


Running a GLMM with binomial family 

```{r}
albo_binomial <- glmer(sugar ~ time*sex* habitat + (1|day) + (1|station), family = binomial, data = TSI_data)
summary(albo_binomial)

#the dispersal parameter value is 1.11. According to dispersion_glmer(blmeco) - the square root of the scale parameter, according to recommendations by D. Bates, if its value is between 0.75 and 1.4, there may not be an overdispersion problem.
dispersion_glmer(albo_binomial)

##using DHARMa to investigate underdispersion and overdispersion

albo_binomial_overdispersion <- simulateResiduals(albo_binomial, plot = T)

residuals(albo_binomial_overdispersion)

residuals(albo_binomial_overdispersion, quantileFunction = qnorm, outlierValues = c(-7,7))

plot(albo_binomial_overdispersion)

#QQ plot distribution test, dispersion test and outlier tests is not significant (good).

#Statistical tests for dispersion

testOverdispersion(albo_binomial_overdispersion)

testDispersion(albo_binomial_overdispersion, alternative = "less", plot = FALSE) # only underdispersion))

testDispersion(albo_binomial_overdispersion, alternative = "greater", plot = FALSE) # only oversispersion

testDispersion(albo_binomial_overdispersion, type = "PearsonChisq", alternative = "greater")

#overall there does not appear to be a problem with this data. 

Anova(albo_binomial)

#the ratio of residual deviance to df is ~1.2
#deviance df.resid 
#2281     1800 

albo_binomial_R2 <- r.squaredGLMM(albo_binomial)

#The model as a whole gives very low prediction of individual responses.

#tukey post hoc test

Tukey_sugar_Binomial <- emmeans(albo_binomial, list(pairwise ~ time*sex), adjust = "tukey")
confint(Tukey_sugar_Binomial, level = 0.95)

Tukey_sugar_Binomial

#significant difference between sugar presence in (i) afternoon female - afternoon male (ii) morning female - afternoon male (iii) afternoon male - morning male. 

gof(albo_binomial)
sum(residuals(albo_binomial,"pearson")^2)

#residuals are very high - not a great thing.

```

Running a GLMM with negative binomial family 

```{r}

albo_n_b <- glmer.nb(sugar ~ time*sex* habitat + (1|day) + (1|station), data = TSI_data)
#warning messages (bounday (singular), iteration limit reached boundary).
summary(albo_n_b)
#the ratio of residual deviance to df is ~1.5.
#deviance df.resid 
#2692     1799 

dispersion_glmer(albo_n_b)

#dispersion parameter is 0.82. This is considerably lower than the binomial family model. According to dispersion_glmer(blmeco) by D. Bates, if its value is between 0.75 and 1.4, there may not be an overdispersion problem. Examination of the residuals is required though. 

##using DHARMa to investigate underdispersion and overdispersion

albo_n_b_overdispersion <- simulateResiduals(albo_n_b, plot = T)

residuals(albo_n_b_overdispersion)

residuals(albo_n_b_overdispersion, quantileFunction = qnorm, outlierValues = c(-7,7))

plot(albo_n_b_overdispersion)

#QQ plot distribution test, dispersion test and outlier tests to be significant for the negative binomial model (not great)

testOverdispersion(albo_n_b_overdispersion)

testDispersion(albo_n_b_overdispersion, alternative = "less", plot = FALSE) # only underdispersion))

testDispersion(albo_n_b_overdispersion, alternative = "greater", plot = FALSE) # only oversispersion

testDispersion(albo_n_b_overdispersion, type = "PearsonChisq", alternative = "greater")

testOutliers(albo_n_b_overdispersion, alternative = c("two.sided", "greater",
  "less"), margin = c("both", "upper", "lower"), type = c("default",
  "bootstrap", "binomial"), nBoot = 100, plot = T)

Anova(albo_n_b)

#It appears that there is singularity in the data. If the fit is singular, there might be a higher chance of a false positive.

albo_n_b_R2 <- r.squaredGLMM(albo_n_b)

#tukey post hoc test

Tukey_sugar_albo_n_b <- emmeans(albo_n_b, list(pairwise ~ time*sex), adjust = "tukey")
confint(Tukey_sugar_albo_n_b, level = 0.95)

Tukey_sugar_albo_n_b

#significant difference between sugar positive for (i) afternoon female - afternoon male (ii) morning female - afternoon male (iii) afternoon male - morning male. 

#these results are the same as the binomial family, but the (i) has a slightly higher, albeit still significant, p value.  

```

Comparison of the two models
```{r}
#compare the residuals between models

#negative binomial - residuals 1062
sum(residuals(albo_n_b,"pearson")^2)

#binomial - residuals 1788
sum(residuals(albo_binomial,"pearson")^2)

#compare AIC weights between models:

AIC(albo_binomial, albo_n_b)

#the binomial model has the lower AIC weight.

#Compare the R2 between different models

#negative binomial
albo_n_b_R2

#binomial
albo_binomial_R2

#CONCLUSION 

#the binomial model has the lowest AIC weights, but the highest residuals. I think it might be a better fit for the data, considering the results from DHARMa in finding the QQ plot distribution test, dispersion test and outlier tests to be not significant. These tests were significant for the negative binomial model (not great). 
```





