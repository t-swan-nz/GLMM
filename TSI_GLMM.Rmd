Loading packages
```{r}
library(qtl)
library(ggplot2)
library(pscl)
library(boot)
library(psych) 
library(stats) 
library(MASS)
library(car)
library(lmtest)
library(lme4)
library(tidyverse)
library(plyr)
library(tibble)
library(readxl)
library(aods3)
library(emmeans)
library(MuMIn)
library(DHARMa)
```

Importing the data
```{r}
TSI_data <- read.csv(file = "TSI_data.csv")
```

Running a GLMM with a negative binomial family

```{r}

albo_n_b <- glmer.nb(sugar ~ time + sex + habitat + (1|day) + (1|station), data = TSI_data)
summary(albo_n_b)
Anova(albo_n_b)

#check singularity
tt <- getME(albo_n_b,"theta")
ll <- getME(albo_n_b,"lower")
min(tt[ll==0])

#It appears that there is singularity in the data. If the fit is singular, there might be a higher chance of a false positive.

#the ratio of residual deviance to df is ~1.5.
#deviance df.resid 
#2719.2     1803 

```

Running a GLMM with binomial family 

```{r}
albo_binomial <- glmer(sugar ~ time + sex + habitat + (1|day) + (1|station), family = binomial, data = TSI_data)
summary(albo_binomial)
Anova(albo_binomial)

#the ratio of residual deviance to df is ~1.2
#deviance df.resid 
#2323     1804 

r.squaredGLMM(albo_binomial)

#The model as a whole gives very low prediction of individual responses.

#tukey post hoc test

Tukey_sugar_Binomial <- emmeans(albo_binomial, list(pairwise ~ time), adjust = "tukey")
confint(Tukey_sugar_Binomial, level = 0.95)

Tukey_sugar_Binomial

#significant difference between time of day. But what if we only want to test this effect for males or ONLY for females?

#Maybe we need to flesh this out as two datasets: 1 for females, 1 for males. 

```

Running a GLMM with a poisson family
```{r}

albo_poisson <- glmer(sugar ~  time + sex + habitat + (1|day) + (1|station), family = poisson, data = TSI_data)
summary(albo_poisson)
Anova(albo_poisson)

#looks like just time of day is significantly different.

#the ratio of residual deviance to df is ~1.5.
#deviance df.resid 
#2719.2     1804 

r.squaredGLMM(albo_poisson)

#The model as a whole gives very low prediction of individual responses.

#using DHARMa to investigate underdispersion and overdispersion

albo_poisson_overdispersion <- simulateResiduals(albo_poisson, plot = F)

residuals(albo_poisson_overdispersion)

residuals(albo_poisson_overdispersion, quantileFunction = qnorm, outlierValues = c(-7,7))

plot(albo_poisson_overdispersion)

testOverdispersion(albo_poisson_overdispersion)

testDispersion(albo_poisson_overdispersion, alternative = "less", plot = FALSE) # only underdispersion))

testDispersion(albo_poisson_overdispersion, alternative = "greater", plot = FALSE) # only oversispersion

testDispersion(albo_poisson_overdispersion, type = "PearsonChisq", alternative = "greater")

testOutliers(albo_poisson_overdispersion, alternative = c("two.sided", "greater",
  "less"), margin = c("both", "upper", "lower"), type = c("default",
  "bootstrap", "binomial"), nBoot = 100, plot = T)

#looks like there is some overdispersion - investigate this more. 

```

Compare the residuals between all the models
```{r}
#compare the residuals between models

#negative binomial - residuals 1062
sum(residuals(albo_n_b,"pearson")^2)

#binomial - residuals 1788
sum(residuals(albo_binomial,"pearson")^2)

#poisson - residuals 1062.
sum(residuals(albo_poisson,"pearson")^2)

#compare AIC weights between models:

AIC(albo_binomial, albo_n_b, albo_poisson)

#the binomial model has the lowest AIC weight.

#CONCLUSION 

#the binomial model has the lowest AIC weights, but the highest residuals (most overdispersed). None of the models do a great job at predicting the proportion of variance explained by the model as a whole (low R2).

```

Fitting only the male mosquitoes
```{r}

TSI_data_male <- read.csv(file = "TSI_data_male.csv")

male_albo_binomial <- glmer(sugar ~ time + habitat + (1|day) + (1|station), family = binomial, data = TSI_data_male)
summary(male_albo_binomial)
Anova(male_albo_binomial)

#the binomial models has a lower AIC.

r.squaredGLMM(male_albo_binomial)


#testing for overdispersion with the negative binomial model

overdisp_Binomial_male <- gof(male_albo_binomial)
sum(residuals(overdisp_Binomial_male,"pearson")^2)

#tukey post hoc test

Tukey_sugar_NB_male <- emmeans(male_albo_binomial, list(pairwise ~ time), adjust = "tukey")
confint(Tukey_sugar_NB_male, level = 0.95)

Tukey_sugar_NB_male

# significant difference between sugar fed status by time of day

```
Fitting only the female mosquitoes 

```{r}
TSI_data_female <- read.csv(file = "TSI_data_female.csv")

female_albo_binomial <- glmer(sugar ~ time + habitat + (1|day) + (1|station), family = binomial, data = TSI_data_female)
summary(female_albo_binomial)
Anova(female_albo_binomial)

#the binomial models has a lower AIC.

r.squaredGLMM(female_albo_binomial)

#testing for overdispersion with the negative binomial model

overdisp_NB_female <- gof(female_albo_binomial)
sum(residuals(overdisp_NB_female,"pearson")^2)

#tukey post hoc test

Tukey_sugar_NB_female <- emmeans(female_albo_binomial, list(pairwise ~ time), adjust = "tukey")
confint(Tukey_sugar_NB_female, level = 0.95)

Tukey_sugar_NB_female

#this shows that the time of day that they were sugar fed was significantly different for females. 
```




