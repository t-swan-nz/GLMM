Loading packages
```{r}
library(qtl)
library(ggplot2)
library(pscl)
library(boot)
library(psych) 
library(stats) 
library(MASS)
library(car)
library(lmtest)
library(lme4)
library(tidyverse)
library(tibble)
library(aods3)
library(emmeans)
library(dplyr)
library(MuMIn)
library(DHARMa)
library(blmeco)
library(cowplot)
library(ResourceSelection)
```

Importing the data
```{r}
TSI_data <- read.csv(file = "TSI_data.csv")
```

Summary statistics
```{r}

#convert the sugar integer to a factor

TSI_data_plots <- TSI_data %>% mutate(sugar= as.factor(sugar))

#confirm that this is now a factor. 
str(TSI_data_plots)

#More females than males captured in the urban environment. #more male albopictus captured in the bush than in the urban habitat.
TSI_data_plots %>% ggplot(mapping = aes(x =sex, fill=habitat)) + geom_bar(position = "dodge")

#time of day - more female captured in the afternoon 
TSI_data_plots %>% ggplot(mapping = aes(x =sex, fill=time)) + geom_bar(position = "dodge")

#maybe look at fructose concentration by sex
TSI_data_plots %>% ggplot() + geom_point(aes(y= fructose_concentration, x=habitat, color = sex))

TSI_data_plots %>% ggplot() + geom_point(aes(y= sweeptime, x=habitat, color = time))

#look at differences between time of day, sugar positive and sex - this one relates to the GLMM.#significant difference between sugar positive for (i) afternoon female - afternoon male (ii) morning female - afternoon male (iii) afternoon male - morning male. 

#there was more sugar feeding in the afternoon than the morning. 

#Sweeptime with habitat, filled with sex. Doesn't appear to be significantly different.

TSI_data_plots %>% ggplot(mapping = aes(x=habitat, y=sweeptime)) + 
  geom_point()

#concentration of fructose by habitat type - no significant difference.
TSI_data_plots %>% ggplot() + 
  geom_point(aes(x=habitat, y=fructose_concentration, color=sex))


#fructose concentration - by male and female for each habitat type. Maybe difference between Male and Female for urban environment?

TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=fructose_concentration)) + geom_bar(position="dodge") 

TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="dodge") + facet_grid(~fct_rev(time)) + labs(x= "Sex", y = "Count", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#final figures examples

#1. Figure: Count of sugar fed status by time of day for both male and female Aedes albopictus. would be good to include the n in this. 
#why are males less sugar fed in the afternoon compared to females?
#think about a facet_grid for comparing count with sex, facetted by time of day. #this one shows that more females than males were captured in both the morning and afternoon.

TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="dodge") + facet_grid(~fct_rev(time)) + labs(x= "Sex", y = "Count", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#this graph here shows proportion.
TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="fill") + facet_grid(~fct_rev(time)) + labs(x= "Sex", y = "Proportion", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#Figure 2: 
#Quite interesting. Our physiological examination was able to detect the presence of sugar for nearly all mossies that were clear. Unfed it could not dectet. 

#this graph shows count

TSI_data_plots %>% ggplot(mapping = aes(x=contents, fill=sugar)) + geom_bar(position="dodge")+ labs(x= "Visual examination", y = "Count", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))

#this graph here shows proportion.

TSI_data_plots %>% ggplot(mapping = aes(x=contents, fill=sugar)) + geom_bar(position="fill")+ labs(x= "Visual examination", y = "Proportion", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))

#Figure 3: Habitat, sex and sugar
TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="dodge") + facet_grid(~fct_rev(habitat)) + labs(x= "Sex", y = "Count", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#This graph shows proportion

TSI_data_plots %>% ggplot(mapping = aes(x=sex, fill=sugar)) + geom_bar(position="fill") + facet_grid(~fct_rev(habitat)) + labs(x= "Sex", y = "Proportion", fill= "Sugar fed") + scale_fill_discrete(labels= c("Negative", "Positive"))+ theme_cowplot()

#there is no statistical difference between male and female sugar positivity in either the urban or bush habitat types.

```


Running a GLMM with binomial family 

```{r}

#consider changing the terms to all interactions. Await Rhondda's feedback re: model. 
albo_binomial <- glmer(sugar ~ time*sex*habitat + (1|day) + (1|station), family = binomial, data = TSI_data)
summary(albo_binomial)
Anova(albo_binomial)

#tukey post hoc test

Tukey_sugar_Binomial <- emmeans(albo_binomial, list(pairwise ~ time+sex), adjust = "tukey")
#confint(Tukey_sugar_Binomial, level = 0.95)

Tukey_sugar_Binomial

#significant difference between sugar presence in (i) afternoon female - afternoon male (ii) morning female - afternoon male (iii) afternoon male - morning male. 

#Hosmer and Lemeshow goodness of fit (GOF) test - is there a significant difference in the distribution of positive values from what the model predicts. 

hoslem.test(TSI_data$sugar, fitted(albo_binomial))

#data:  TSI_data$sugar, fitted(albo_binomial)
#X-squared = 15.437, df = 8, p-value > 0.05119
```
